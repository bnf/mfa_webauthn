import{LitElement as e,html as t}from"lit";function n(e){const t=new Uint8Array(e);let n="";for(const e of t)n+=String.fromCharCode(e);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function i(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=(4-t.length%4)%4,i=t.padEnd(t.length+n,"="),r=atob(i),a=new ArrayBuffer(r.length),o=new Uint8Array(a);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);return a}function r(){return void 0!==window?.PublicKeyCredential&&"function"==typeof window.PublicKeyCredential}function a(e){const{id:t}=e;return{...e,id:i(t),transports:e.transports}}function o(e){return"localhost"===e||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(e)}class s extends Error{code;constructor({message:e,code:t,cause:n,name:i}){super(e,{cause:n}),this.name=i??n.name,this.code=t}}const l=new class{controller;createNewAbortSignal(){if(this.controller){const e=new Error("Cancelling existing WebAuthn API call for new one");e.name="AbortError",this.controller.abort(e)}const e=new AbortController;return this.controller=e,e.signal}},c=["cross-platform","platform"];function u(e){if(e&&!(c.indexOf(e)<0))return e}async function d(e){if(!r())throw new Error("WebAuthn is not supported in this browser");var t;const c={publicKey:{...e,challenge:i(e.challenge),user:{...e.user,id:(t=e.user.id,(new TextEncoder).encode(t))},excludeCredentials:e.excludeCredentials?.map(a)}};let d;c.signal=l.createNewAbortSignal();try{d=await navigator.credentials.create(c)}catch(e){throw function({error:e,options:t}){const{publicKey:n}=t;if(!n)throw Error("options was missing required publicKey property");if("AbortError"===e.name){if(t.signal instanceof AbortSignal)return new s({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if("ConstraintError"===e.name){if(!0===n.authenticatorSelection?.requireResidentKey)return new s({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if("required"===n.authenticatorSelection?.userVerification)return new s({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if("InvalidStateError"===e.name)return new s({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if("NotAllowedError"===e.name)return new s({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if("NotSupportedError"===e.name)return 0===n.pubKeyCredParams.filter((e=>"public-key"===e.type)).length?new s({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new s({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if("SecurityError"===e.name){const t=window.location.hostname;if(!o(t))return new s({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e});if(n.rp.id!==t)return new s({message:`The RP ID "${n.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else if("TypeError"===e.name){if(n.user.id.byteLength<1||n.user.id.byteLength>64)return new s({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if("UnknownError"===e.name)return new s({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}({error:e,options:c})}if(!d)throw new Error("Registration was not completed");const{id:h,rawId:p,response:b,type:m}=d;let w;return"function"==typeof b.getTransports&&(w=b.getTransports()),{id:h,rawId:n(p),response:{attestationObject:n(b.attestationObject),clientDataJSON:n(b.clientDataJSON),transports:w},type:m,clientExtensionResults:d.getClientExtensionResults(),authenticatorAttachment:u(d.authenticatorAttachment)}}async function h(e,t=!1){if(!r())throw new Error("WebAuthn is not supported in this browser");let c;0!==e.allowCredentials?.length&&(c=e.allowCredentials?.map(a));const d={...e,challenge:i(e.challenge),allowCredentials:c},h={};if(t){if(!await async function(){const e=window.PublicKeyCredential;return void 0!==e.isConditionalMediationAvailable&&e.isConditionalMediationAvailable()}())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete*='webauthn']").length<1)throw Error('No <input> with `"webauthn"` in its `autocomplete` attribute was detected');h.mediation="conditional",d.allowCredentials=[]}let p;h.publicKey=d,h.signal=l.createNewAbortSignal();try{p=await navigator.credentials.get(h)}catch(e){throw function({error:e,options:t}){const{publicKey:n}=t;if(!n)throw Error("options was missing required publicKey property");if("AbortError"===e.name){if(t.signal instanceof AbortSignal)return new s({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else{if("NotAllowedError"===e.name)return new s({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if("SecurityError"===e.name){const t=window.location.hostname;if(!o(t))return new s({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e});if(n.rpId!==t)return new s({message:`The RP ID "${n.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else if("UnknownError"===e.name)return new s({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return e}({error:e,options:h})}if(!p)throw new Error("Authentication was not completed");const{id:b,rawId:m,response:w,type:f}=p;let g;var R;return w.userHandle&&(R=w.userHandle,g=new TextDecoder("utf-8").decode(R)),{id:b,rawId:n(m),response:{authenticatorData:n(w.authenticatorData),clientDataJSON:n(w.clientDataJSON),signature:n(w.signature),userHandle:g},type:f,clientExtensionResults:p.getClientExtensionResults(),authenticatorAttachment:u(p.authenticatorAttachment)}}class p extends HTMLElement{connectedCallback(){const e=document.createElement("input");e.setAttribute("type","hidden"),e.setAttribute("name","webauthn_publicKeyCredential"),this.appendChild(e);let t=this.parentElement;for(;"form"!==t.tagName.toLowerCase();)t=t.parentElement;t.addEventListener("submit",(n=>{if(e.value)return;n.preventDefault();h(JSON.parse(this.getAttribute("credential-request-options"))).then((n=>{e.value=JSON.stringify(n),t.requestSubmit()}),(e=>{console.log(e)}))})),t.requestSubmit()}}window.customElements.define("mfa-webauthn-authenticator",p);window.customElements.define("mfa-webauthn-setup",class extends e{static get properties(){return{mode:{type:String},credentials:{type:Object},credentialCreationOptions:{type:Object,attribute:"credential-creation-options"},labels:{type:Object},publicKeyCredential:{type:String,attribute:!1},publicKeyDescription:{type:String,attribute:!1},publicKeyIcon:{type:String,attribute:!1},action:{type:String,attribute:!1},loading:{type:Boolean,attribute:!1}}}render(){const e="add"===this.action?"fa-check":this.loading?"fa-circle-o-notch fa-spin":"fa-plus";return t`<input type="hidden" name="webauthn_publicKeyCredential" .value="${this.publicKeyCredential}"> <input type="hidden" name="webauthn_publicKeyDescription" .value="${this.publicKeyDescription}"> <input type="hidden" name="webauthn_publicKeyIcon" .value="${this.publicKeyIcon}"> <input type="hidden" name="webauthn_action" .value="${this.action}"> ${0===Object.keys(this.credentials).length?t`<div class="callout" style="margin-top:0"><h4 class="callout-title">No ${this.labels.plural} added</h4><div class="callout-body">Configure ${this.labels.plural} below</div></div>`:t`<table class="table" style="max-width:450px;word-break:break-all"><thead><tr><th class="col-icon"><button class="btn btn-default" @click="${this._createCredentials}"><i class="fa ${e} fa-fw"></i></button></th><th colspan="2">Registered ${this.labels.plural}</th></tr><tr></tr></thead><tbody>${Object.keys(this.credentials).map((e=>t`<tr id="credential-${e}"><td class="col-icon">${this._getIcon(this.credentials[e].icon||"key")}</td><td class="col-title">${this.credentials[e].description||"(unnamed)"}<br><span class="text-muted">Last used: ${this._formatDate(this.credentials[e].updated)}</span></td><td class="col-control"><div class="btn-group" role="group"><button class="btn btn-link" title="Remove ${this.labels.singular}" @click="${t=>this._removeCredentials(t,e)}">${this._getIcon("trash")}</button></div></td></tr>`))}</tbody></table>`} <button class="btn btn-default btn-lg" @click="${this._createCredentials}"><i class="fa ${e} fa-fw"></i> Add ${this.labels.singular}</button>`}createRenderRoot(){return this}connectedCallback(){for(this.publicKeyCrendetial="",this.publicKeyDescription="",this.action="",this.form=this.parentElement;"form"!==this.form.tagName.toLowerCase();)this.form=this.form.parentElement;super.connectedCallback(),"setup"===this.mode&&this._createCredentials()}_createCredentials(e){e&&e.preventDefault();const t=JSON.parse(JSON.stringify(this.credentialCreationOptions));this.loading=!0,d(t).then((e=>{this.action="add",this.publicKeyCredential=JSON.stringify(e),this.publicKeyIcon="key";let t=this.labels.defaultName;if("platform"===this.credentialCreationOptions.authenticatorSelection.authenticatorAttachment){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);t="My "+(e?"Phone":"Computer"),this.publicKeyIcon=e?"mobile":"computer"}const n=window.prompt("Please provide a name for this "+this.labels.signular+".",t);this.publicKeyDescription=n,this.loading=!1,this.updateComplete.then((()=>this.form.requestSubmit()))}),(e=>{this.loading=!1,console.log(e)}))}_removeCredentials(e,t){e.preventDefault(),this.action="remove";const n=this.credentials[t].description||"(unnamed)";window.confirm("Do you really want to delete the "+this.labels.singular+' "'+n+'"?')&&(this.publicKeyCredential=JSON.stringify(this.credentials[t].publickey),this.updateComplete.then((()=>this.form.requestSubmit())))}_formatDate(e){if(!e)return"never";const t=new Date(1e3*e);return t.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})+" "+t.toLocaleTimeString("en-US")}_getIcon(e){return"mobile"===e?t`<svg viewBox="0 0 24 24" fill="#999" width="32" height="32"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg>`:"computer"===e?t`<svg viewBox="0 0 24 24" fill="#999" width="32" height="32"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>`:"trash"===e?t`<svg viewBox="0 0 24 24" fill="currentColor" fill-opacity=".8" width="24" height="24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"/></svg>`:t`<svg width="32" height="48" viewBox="4 0 16 24" fill="#777"><path d="M8 1c-1.1 0-2 .9-2 2v12.5c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm4 4.416l3 1.334v2c0 1.85-1.28 3.58-3 4-1.72-.42-3-2.15-3-4v-2zm0 .73L9.666 7.184V9.08c.177 1.373 1.094 2.597 2.334 2.98V6.147zM9 18v5h6v-5z"/></svg>`}});
