import{LitElement as e,html as t}from"lit";const i=e=>{const t=(e=e.replace(/-/g,"+").replace(/_/g,"/")).length%4;if(t){if(1===t)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-t).join("=")}return window.atob(e)},n=e=>btoa(String.fromCharCode(...e)),a=e=>(e.challenge=Uint8Array.from(i(e.challenge),(e=>e.charCodeAt(0))),void 0!==e.user&&(e.user={...e.user,id:Uint8Array.from(window.atob(e.user.id),(e=>e.charCodeAt(0)))}),void 0!==e.excludeCredentials&&(e.excludeCredentials=e.excludeCredentials.map((e=>({...e,id:Uint8Array.from(i(e.id),(e=>e.charCodeAt(0)))})))),void 0!==e.allowCredentials&&(e.allowCredentials=e.allowCredentials.map((e=>({...e,id:Uint8Array.from(i(e.id),(e=>e.charCodeAt(0)))})))),e),r=e=>{const t={id:e.id,type:e.type,rawId:n(new Uint8Array(e.rawId)),response:{clientDataJSON:n(new Uint8Array(e.response.clientDataJSON))}};return void 0!==e.response.attestationObject&&(t.response.attestationObject=n(new Uint8Array(e.response.attestationObject))),void 0!==e.response.authenticatorData&&(t.response.authenticatorData=n(new Uint8Array(e.response.authenticatorData))),void 0!==e.response.signature&&(t.response.signature=n(new Uint8Array(e.response.signature))),void 0!==e.response.userHandle&&(t.response.userHandle=n(new Uint8Array(e.response.userHandle))),t};class s extends HTMLElement{connectedCallback(){const e=document.createElement("input");e.setAttribute("type","hidden"),e.setAttribute("name","webauthn_publicKeyCredential"),this.appendChild(e);let t=this.parentElement;for(;"form"!==t.tagName.toLowerCase();)t=t.parentElement;const i=a(JSON.parse(this.getAttribute("credential-request-options")));t.addEventListener("submit",(n=>{e.value||(n.preventDefault(),navigator.credentials.get({publicKey:i}).then((i=>{e.value=JSON.stringify(r(i)),t.requestSubmit()}),(e=>{console.log(e)})))})),t.requestSubmit()}}window.customElements.define("mfa-webauthn-authenticator",s);window.customElements.define("mfa-webauthn-setup",class extends e{static get properties(){return{mode:{type:String},credentials:{type:Object},credentialCreationOptions:{type:Object,attribute:"credential-creation-options"},labels:{type:Object},publicKeyCredential:{type:String,attribute:!1},publicKeyDescription:{type:String,attribute:!1},publicKeyIcon:{type:String,attribute:!1},action:{type:String,attribute:!1},loading:{type:Boolean,attribute:!1}}}render(){const e="add"===this.action?"fa-check":this.loading?"fa-circle-o-notch fa-spin":"fa-plus";return t`<input type="hidden" name="webauthn_publicKeyCredential" .value="${this.publicKeyCredential}"> <input type="hidden" name="webauthn_publicKeyDescription" .value="${this.publicKeyDescription}"> <input type="hidden" name="webauthn_publicKeyIcon" .value="${this.publicKeyIcon}"> <input type="hidden" name="webauthn_action" .value="${this.action}"> ${0===Object.keys(this.credentials).length?t`<div class="callout" style="margin-top:0"><h4 class="callout-title">No ${this.labels.plural} added</h4><div class="callout-body">Configure ${this.labels.plural} below</div></div>`:t`<table class="table" style="max-width:450px;word-break:break-all"><thead><tr><th class="col-icon"><button class="btn btn-default" @click="${this._createCredentials}"><i class="fa ${e} fa-fw"></i></button></th><th colspan="2">Registered ${this.labels.plural}</th></tr><tr></tr></thead><tbody>${Object.keys(this.credentials).map((e=>t`<tr id="credential-${e}"><td class="col-icon">${this._getIcon(this.credentials[e].icon||"key")}</td><td class="col-title">${this.credentials[e].description||"(unnamed)"}<br><span class="text-muted">Last used: ${this._formatDate(this.credentials[e].updated)}</span></td><td class="col-control"><div class="btn-group" role="group"><button class="btn btn-link" title="Remove ${this.labels.singular}" @click="${t=>this._removeCredentials(t,e)}">${this._getIcon("trash")}</button></div></td></tr>`))}</tbody></table>`} <button class="btn btn-default btn-lg" @click="${this._createCredentials}"><i class="fa ${e} fa-fw"></i> Add ${this.labels.singular}</button>`}createRenderRoot(){return this}connectedCallback(){for(this.publicKeyCrendetial="",this.publicKeyDescription="",this.action="",this.form=this.parentElement;"form"!==this.form.tagName.toLowerCase();)this.form=this.form.parentElement;super.connectedCallback(),"setup"===this.mode&&this._createCredentials()}_createCredentials(e){e&&e.preventDefault();const t=a(JSON.parse(JSON.stringify(this.credentialCreationOptions)));this.loading=!0,navigator.credentials.create({publicKey:t}).then((e=>{this.action="add",this.publicKeyCredential=JSON.stringify(r(e)),this.publicKeyIcon="key";let t=this.labels.defaultName;if("platform"===this.credentialCreationOptions.authenticatorSelection.authenticatorAttachment){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);t="My "+(e?"Phone":"Computer"),this.publicKeyIcon=e?"mobile":"computer"}const i=window.prompt("Please provide a name for this "+this.labels.signular+".",t);this.publicKeyDescription=i,this.loading=!1,this.updateComplete.then((()=>this.form.requestSubmit()))}),(e=>{this.loading=!1,console.log(e)}))}_removeCredentials(e,t){e.preventDefault(),this.action="remove";const i=this.credentials[t].description||"(unnamed)";window.confirm("Do you really want to delete the "+this.labels.singular+' "'+i+'"?')&&(this.publicKeyCredential=JSON.stringify(this.credentials[t].publickey),this.updateComplete.then((()=>this.form.requestSubmit())))}_formatDate(e){if(!e)return"never";const t=new Date(1e3*e);return t.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})+" "+t.toLocaleTimeString("en-US")}_getIcon(e){return"mobile"===e?t`<svg viewBox="0 0 24 24" fill="#999" width="32" height="32"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg>`:"computer"===e?t`<svg viewBox="0 0 24 24" fill="#999" width="32" height="32"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>`:"trash"===e?t`<svg viewBox="0 0 24 24" fill="currentColor" fill-opacity=".8" width="24" height="24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"/></svg>`:t`<svg width="32" height="48" viewBox="4 0 16 24" fill="#777"><path d="M8 1c-1.1 0-2 .9-2 2v12.5c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm4 4.416l3 1.334v2c0 1.85-1.28 3.58-3 4-1.72-.42-3-2.15-3-4v-2zm0 .73L9.666 7.184V9.08c.177 1.373 1.094 2.597 2.334 2.98V6.147zM9 18v5h6v-5z"/></svg>`}});
